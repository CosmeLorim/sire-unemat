<script>
    var ControllerUsuarios = function (){
    this._elementosVisuais = {
            tituloAcao: $('#titulo-acao'),
            btnAcao: $('#btn-acao'),
            descricaoBtnAcao: $('#descricao-btn-acao'),
            spanPasswd1: $('#span-passwd1'),
            spanPasswd2: $('#span-passwd2'),
            divPasswd2: $('#div-passwd2'),
            btnCancelar: $('#btn-cancelar'),
            btnConsulta: $('#btnConsulta'),
            campoConsulta: $('#campo-consulta'),
            grid: $("#grid-usuarios")
        };
    this._estado = 'cadastro';
    this._dados = { id: 0, nome: '', usr: '', passwd: '', admin: false, tiposObjetos: [] };
    this._formulario = {
        nome: $('#nome'),
        usr: $('#usr'),
        passwd1 :$('#passwd1'),
        passwd2: $('#passwd2'),
        normal: $('#normal'),
        admin: $('#admin'),
        tiposObjetos: $('input[name="tipos-objetos"]')
    };
    this._formulario.usr.mask('999.999.999-99');
    this._urlBase = '/api/usuarios/'
    var it = this;

    this.buscaUsuario = function(id, callback){
        $.ajax({
            url: it._urlBase + id,
            type: 'get',
            success: callback
        })
    }

    this.alternarEstado = function(estado, row) {
        switch(estado){
            case 'alteracao':
                it._elementosVisuais.tituloAcao.html('alteração');
                it._elementosVisuais.descricaoBtnAcao.html('Alterar');
                it._formulario.nome.val(row.nome);
                it._formulario.usr.val(row.usr).mask('999.999.999-99');
                it.alternarEstadoPasswd('opcional');
                it.passwd2Keypress();
                it._formulario.normal.prop('checked', !row.admin);
                it._formulario.admin.prop('checked', row.admin);
                it._formulario.tiposObjetos.each(function(){ $(this).prop('checked', false) });
                it._dados = { id: row.id, nome: row.nome, usr: row.usr, passwd: '', admin: row.admin, tiposObjetos: [] };
                it.buscaUsuario(row.id, function (data, status) {
                    var perfis = JSON.parse(data);
                    for (var index = 0; index < perfis.length; index++)
                        $('#tipo-objeto-' + perfis[index].tipoObjeto).prop('checked', perfis[index].ativo);
                    it._dados.tiposObjetos = perfis;
                });
                it._estado = 'alteracao';
                break;
            case 'cadastro':
                it._elementosVisuais.tituloAcao.html('cadastro');
                it._elementosVisuais.descricaoBtnAcao.html('Cadastrar');
                $('#grid-cursos tr').removeClass('selected')
                it._formulario.nome.val('');
                it._formulario.usr.val('').mask('999.999.999-99');
                it.alternarEstadoPasswd('obrigatorio');
                it.passwd2Keypress();
                it._formulario.normal.prop('checked', true);
                it._formulario.admin.prop('checked', false);
                it._formulario.tiposObjetos.each(function(){ $(this).prop('checked', false) });
                it._estado = 'cadastro';
                it._dados = { id: 0, nome: '', usr: '', passwd: '', admin: false, tiposObjetos: [] };
                break;
            default:
                console.error('Valor inválido para alteração de estado');
                break;
        }
    }

    this._elementosVisuais.btnAcao.on('click', function() {
        var usuario = {
            nome: it._formulario.nome.val(),
            usr: it._formulario.usr.mask(),
            passwd: it._formulario.passwd1.val(),
            admin: it._formulario.admin.prop('checked'),
            perfil: function(){
                var perfil= [];
                it._formulario.tiposObjetos.each(function(){
                    perfil.push({ tipoObjeto: $(this).val(), ativo: $(this).prop('checked') });
                });
                return perfil;
            }()
        };

        var validacaoNome = usuario.nome.length === 0 || usuario.nome.length > 120;
        var validacaoUsr = usuario.usr.length !== 11;
        var validacaoPasswd = (usuario.passwd.length > 0 && usuario.passwd.length < 6) || it._formulario.passwd1.val() !== it._formulario.passwd2.val();
        
        if(validacaoNome || validacaoUsr || validacaoPasswd)
            return;
            
        var success = function (data, status) {
            $.Notify({ caption: data.title, content: data.msg, timeout: 10000, type: data.status });
            
            if (data.status === 'success') {
                it.atualizaGrid();
                it.alternarEstado('cadastro');
            }
        };

        switch (it._estado) {
            case 'cadastro':
                if(usuario.passwd.length > 5)
                {
                    usuario.passwd = md5(usuario.passwd);
                    $.ajax({
                        url: it._urlBase,
                        type: 'post',
                        data: usuario,
                        success: success
                    })
                }                   
                break;
            case 'alteracao':
                if(usuario.passwd.length === 0)
                    delete usuario.passwd
                else
                    usuario.passwd = md5(usuario.passwd);
                $.ajax({
                    url: it._urlBase + it._dados.usr,
                    type: 'put',
                    data: usuario,
                    success: success
                })
                break;
            default:
                $.Notify({ caption: 'Erro na página.', content: 'Estado da página incorreto', timeout: 5000, type: 'alert' });
                console.error('Estado do controller do tipo "ControllerUsuarios" incorreto.');
                break;
        }
    });

    this._elementosVisuais.btnCancelar.on('click', function(){
        it.alternarEstado('cadastro');
    });

    this._elementosVisuais.btnConsulta.on('click', function () {
        it.atualizaGrid();
    });

    this.formatarTipo = function(admin){ return admin ? "Administrador" : "Comum" };

    this.formatarUsr = function(usr){ return usr.substr(0, 3) + '.' + usr.substr(3, 3) + '.' + usr.substr(6, 3) + '-' + usr.substr(9, 2) };

    this._elementosVisuais.grid.bootstrapTable({
        url: it._urlBase,
        pageSize: 10,
        pagination: true,
        locale: 'pt-BR',
        queryParams: function(params){
            return {
                limit: params.limit,
                offset: params.offset,
                order: params.order,
                txConsulta: it._elementosVisuais.campoConsulta.val()
            };
        },
        sidePagination: 'server',
        columns: [
            { field: 'nome', title: 'Nome', width: '55%' },
            { field: 'usr', title: 'Usuário', width: '25%', formatter: it.formatarUsr },
            { field: 'admin', title: 'Tipo', width: '20%', formatter: it.formatarTipo }
        ],
        onClickRow: function (row) {
            it.alternarEstado(it._dados.id === row.id ? 'cadastro' : 'alteracao', row);
        }
    });

    this.atualizaGrid = function () {
        it._elementosVisuais.grid.bootstrapTable('refresh', {
            url: it._urlBase,
            query: { txConsulta: this._elementosVisuais.campoConsulta.val() }
        });
    }

    this._elementosVisuais.campoConsulta.keypress(function(event){
        if(event.key === 'Enter')
            it.atualizaGrid();
    });

    this.passwd2Keypress = function() {
        it._formulario.passwd2.keypress(function(event){
            if(it._formulario.passwd1.val() !== it._formulario.passwd2.val() + event.key){
                it._elementosVisuais.divPasswd2.removeClass('success');
                it._elementosVisuais.divPasswd2.addClass('error');
            } else {
                it._elementosVisuais.divPasswd2.removeClass('error');
                it._elementosVisuais.divPasswd2.addClass('success');
            }
        })
    };
    this.passwd2Keypress();

    this.alternarEstadoPasswd = function(estado){
        switch (estado) {
            case 'obrigatorio':
                it._elementosVisuais.divPasswd2.removeClass('success error');
                it._elementosVisuais.spanPasswd1.html('<input class="required" type="password" id="passwd1" value="" name="senha" placeholder="Senha" data-validate-func="required, minlength" data-validate-hint="Minimo 6 caracteres!">');
                it._elementosVisuais.spanPasswd2.html('<input class="required" type="password" id="passwd2" value="" placeholder="Confirmação de senha" data-validate-func="required, minlength" data-validate-hint="Minimo 6 caracteres!">');
                it._formulario.passwd1 = $('#passwd1');
                it._formulario.passwd2 = $('#passwd2');
                this.passwd2Keypress();
                break;
        
            case 'opcional':
                it._elementosVisuais.divPasswd2.removeClass('success error');
                it._elementosVisuais.spanPasswd1.html('<input type="password" id="passwd1" value="" name="senha" placeholder="Senha">');
                it._elementosVisuais.spanPasswd2.html('<input type="password" id="passwd2" value="" placeholder="Confirmação de senha">');
                it._formulario.passwd1 = $('#passwd1');
                it._formulario.passwd2 = $('#passwd2');
                this.passwd2Keypress();
                break;

            break;
            default:
                console.error('Valor inválido para alteração de estado');
                break;
        }
    }
}

var controllerUsuario = new ControllerUsuarios();

$("tbody").on("click", "tr", function (e) {
    $(this)
    .toggleClass("selected")
    .siblings(".selected")
    .removeClass("selected");
});
</script>